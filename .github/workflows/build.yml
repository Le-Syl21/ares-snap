# =============================================================================
# Ares Snap Builder - Automated Snap packaging for Ares emulator
# Constructeur Snap Ares - Packaging Snap automatis√© pour l'√©mulateur Ares
# =============================================================================
#
# This workflow automatically builds and publishes Snap packages whenever
# a new version of Ares is released. Builds natively for amd64 and arm64.
#
# Ce workflow construit et publie automatiquement des paquets Snap √† chaque
# nouvelle version d'Ares. Build natif pour amd64 et arm64.
#
# =============================================================================
# EDUCATIONAL PURPOSE / BUT P√âDAGOGIQUE
# =============================================================================
# This repository is designed as a learning resource for packaging any
# application as a Snap. Every section is commented to explain not just
# WHAT it does, but WHY it's configured that way.
#
# Ce d√©p√¥t est con√ßu comme ressource p√©dagogique pour packager n'importe
# quelle application en Snap. Chaque section est comment√©e pour expliquer
# non seulement CE QUE √ßa fait, mais POURQUOI c'est configur√© ainsi.
#
# =============================================================================
# REQUIRED SETUP / CONFIGURATION REQUISE
# =============================================================================
# Before this workflow can run, you need to configure:
# Avant que ce workflow puisse s'ex√©cuter, vous devez configurer :
#
# 1. REPOSITORY VARIABLES (Settings > Secrets and variables > Actions > Variables)
#    VARIABLES DE D√âP√îT
#    - LAST_BUILT_TAG_AMD64 : Tracks last built version for amd64 (e.g., "v139")
#                             Suit la derni√®re version build√©e pour amd64
#    - LAST_BUILT_TAG_ARM64 : Tracks last built version for arm64 (e.g., "v139")
#                             Suit la derni√®re version build√©e pour arm64
#    TIP: Set initial value to "v0" to trigger first build
#    ASTUCE: Mettre "v0" comme valeur initiale pour d√©clencher le premier build
#
# 2. REPOSITORY SECRET (Settings > Secrets and variables > Actions > Secrets)
#    SECRET DE D√âP√îT
#    - SNAPCRAFT_TOKEN : Authentication token for Snap Store publishing
#                        Token d'authentification pour publier sur le Snap Store
#    HOW TO GET IT / COMMENT L'OBTENIR:
#      $ sudo snap install snapcraft --classic
#      $ snapcraft login
#      $ snapcraft export-login snapcraft.login
#      $ cat snapcraft.login  # Copy this content to GitHub secret
#      $ rm snapcraft.login   # Delete for security
#
# 3. WORKFLOW PERMISSIONS (Settings > Actions > General > Workflow permissions)
#    PERMISSIONS DU WORKFLOW
#    Select "Read and write permissions" to allow updating variables
#    S√©lectionner "Read and write permissions" pour permettre la MAJ des variables
#
# =============================================================================

# -----------------------------------------------------------------------------
# WORKFLOW NAME / NOM DU WORKFLOW
# -----------------------------------------------------------------------------
# This name appears in the GitHub Actions tab
# Ce nom appara√Æt dans l'onglet GitHub Actions
name: Build Ares Snap

# -----------------------------------------------------------------------------
# TRIGGERS / D√âCLENCHEURS
# -----------------------------------------------------------------------------
# Defines WHEN this workflow runs
# D√©finit QUAND ce workflow s'ex√©cute
#
# Available triggers / D√©clencheurs disponibles:
#   - push: On every push to specified branches
#   - pull_request: On PR events
#   - schedule: Cron-based scheduling
#   - workflow_dispatch: Manual trigger from GitHub UI
#   - release: When a release is created
#   - And many more... / Et bien d'autres...
# -----------------------------------------------------------------------------
on:
  # SCHEDULED TRIGGER / D√âCLENCHEUR PLANIFI√â
  # ----------------------------------------
  # Cron syntax: minute hour day-of-month month day-of-week
  # Syntaxe cron: minute heure jour-du-mois mois jour-de-semaine
  #
  # Examples / Exemples:
  #   '0 6 * * *'    = Every day at 6:00 UTC / Tous les jours √† 6h UTC
  #   '0 */4 * * *'  = Every 4 hours / Toutes les 4 heures
  #   '0 0 * * 0'    = Every Sunday at midnight / Chaque dimanche √† minuit
  #
  # WHY 6:00 UTC? / POURQUOI 6H UTC ?
  # Most releases happen during US/EU business hours, so checking in the
  # morning UTC catches overnight releases without running too frequently.
  # La plupart des releases arrivent pendant les heures US/EU, donc v√©rifier
  # le matin UTC attrape les releases de nuit sans tourner trop souvent.
  schedule:
    - cron: '0 6 * * *'

  # MANUAL TRIGGER / D√âCLENCHEUR MANUEL
  # ------------------------------------
  # Allows running the workflow from GitHub UI (Actions tab > Run workflow)
  # Permet de lancer le workflow depuis l'UI GitHub (Actions > Run workflow)
  #
  # The 'inputs' section defines parameters the user can set when triggering
  # La section 'inputs' d√©finit les param√®tres que l'utilisateur peut d√©finir
  workflow_dispatch:
    inputs:
      force_build:
        # Description shown in the GitHub UI / Description affich√©e dans l'UI
        description: 'Force build (bypass version check) / Forcer le build (ignorer la v√©rification de version)'
        required: false
        default: false
        type: boolean  # Creates a checkbox in the UI / Cr√©e une checkbox dans l'UI

# -----------------------------------------------------------------------------
# PERMISSIONS
# -----------------------------------------------------------------------------
# GitHub Actions uses a GITHUB_TOKEN with limited permissions by default.
# GitHub Actions utilise un GITHUB_TOKEN avec des permissions limit√©es par d√©faut.
#
# We must explicitly request the permissions we need:
# Nous devons explicitement demander les permissions n√©cessaires :
#
# Common permissions / Permissions courantes:
#   contents: read/write    - Access repository files / Acc√®s aux fichiers du d√©p√¥t
#   actions: read/write     - Manage workflows/artifacts / G√©rer workflows/artifacts
#   packages: read/write    - Publish to GitHub Packages / Publier sur GitHub Packages
#   issues: read/write      - Manage issues / G√©rer les issues
#   pull-requests: write    - Comment on PRs / Commenter sur les PRs
#
# SECURITY TIP / CONSEIL S√âCURIT√â:
# Always use minimum required permissions (principle of least privilege)
# Toujours utiliser le minimum de permissions n√©cessaires (principe du moindre privil√®ge)
# -----------------------------------------------------------------------------
permissions:
  actions: write     # Required for: actions/upload-artifact
                     # Requis pour: actions/upload-artifact
  contents: read     # Required for: actions/checkout, git clone
                     # Requis pour: actions/checkout, git clone

# -----------------------------------------------------------------------------
# JOBS
# -----------------------------------------------------------------------------
# A workflow is made of one or more jobs that run in parallel by default.
# Un workflow est compos√© d'un ou plusieurs jobs qui s'ex√©cutent en parall√®le par d√©faut.
#
# Each job runs on a fresh virtual machine (runner).
# Chaque job s'ex√©cute sur une machine virtuelle fra√Æche (runner).
#
# Jobs can depend on each other using 'needs:', which makes them sequential.
# Les jobs peuvent d√©pendre les uns des autres avec 'needs:', ce qui les rend s√©quentiels.
#
# ARCHITECTURE / ARCHITECTURE:
# We use TWO independent jobs (amd64 + arm64) instead of a matrix strategy
# because each architecture needs to track its own "last built" version.
# This allows one arch to build while the other skips if already up-to-date.
#
# Nous utilisons DEUX jobs ind√©pendants (amd64 + arm64) au lieu d'une strat√©gie
# matrix car chaque architecture doit suivre sa propre version "dernier build".
# Cela permet √† une arch de builder pendant que l'autre passe si d√©j√† √† jour.
# -----------------------------------------------------------------------------
jobs:
  # ===========================================================================
  # JOB: build-amd64
  # ===========================================================================
  # Builds the Snap package for Intel/AMD 64-bit processors
  # Construit le paquet Snap pour les processeurs Intel/AMD 64-bit
  # ===========================================================================
  build-amd64:
    # RUNNER SELECTION / S√âLECTION DU RUNNER
    # --------------------------------------
    # 'runs-on' specifies which type of machine runs this job
    # 'runs-on' sp√©cifie quel type de machine ex√©cute ce job
    #
    # GitHub-hosted runners / Runners h√©berg√©s par GitHub:
    #   ubuntu-latest      - Ubuntu LTS (currently 22.04), x64
    #   ubuntu-24.04       - Ubuntu 24.04, x64
    #   ubuntu-24.04-arm   - Ubuntu 24.04, ARM64 (for native ARM builds)
    #   windows-latest     - Windows Server
    #   macos-latest       - macOS (currently macOS 14, ARM64)
    #   macos-13           - macOS 13, x64
    #
    # You can also use self-hosted runners for custom hardware
    # Vous pouvez aussi utiliser des runners self-hosted pour du hardware custom
    runs-on: ubuntu-latest

    # STEPS / √âTAPES
    # --------------
    # Steps run sequentially within a job
    # Les √©tapes s'ex√©cutent s√©quentiellement dans un job
    steps:
      # -----------------------------------------------------------------------
      # STEP 1: Check for new version
      # √âTAPE 1: V√©rifier s'il y a une nouvelle version
      # -----------------------------------------------------------------------
      # This step queries the upstream repository to find the latest release
      # tag, then compares it against our stored "last built" variable.
      #
      # Cette √©tape interroge le d√©p√¥t upstream pour trouver le dernier tag
      # de release, puis le compare avec notre variable "dernier build" stock√©e.
      #
      # WHY CHECK FIRST? / POURQUOI V√âRIFIER D'ABORD ?
      # To avoid wasting CI resources rebuilding the same version every day.
      # Pour √©viter de gaspiller des ressources CI √† rebuilder la m√™me version.
      # -----------------------------------------------------------------------
      - name: Check for new version
        id: check  # ID allows other steps to reference this step's outputs
                   # L'ID permet aux autres √©tapes de r√©f√©rencer les outputs de cette √©tape
        run: |
          # Fetch all tags matching 'v*' pattern from upstream repository
          # R√©cup√®re tous les tags correspondant au pattern 'v*' du d√©p√¥t upstream
          #
          # Command breakdown / D√©composition de la commande:
          #   git ls-remote --tags  : List remote tags without cloning
          #                           Liste les tags distants sans cloner
          #   cut -d/ -f3           : Extract tag name from refs/tags/v123
          #                           Extrait le nom du tag de refs/tags/v123
          #   sort -V               : Version sort (v2 < v10, not alphabetical)
          #                           Tri par version (v2 < v10, pas alphab√©tique)
          #   tail -1               : Get the last (highest) version
          #                           Prend la derni√®re (plus haute) version
          LATEST_TAG=$(git ls-remote --tags https://github.com/ares-emulator/ares.git 'refs/tags/v*' \
            | cut -d/ -f3 \
            | sort -V \
            | tail -1)

          echo "=========================================="
          echo "Latest release tag: $LATEST_TAG"
          echo "Last built (amd64): ${{ vars.LAST_BUILT_TAG_AMD64 }}"
          echo "=========================================="

          # DECISION LOGIC / LOGIQUE DE D√âCISION
          # ${{ inputs.force_build }} : Value from manual trigger checkbox
          #                             Valeur de la checkbox du d√©clencheur manuel
          # ${{ vars.LAST_BUILT_TAG_AMD64 }} : Repository variable value
          #                                    Valeur de la variable de d√©p√¥t
          if [ "${{ inputs.force_build }}" == "true" ]; then
            echo "‚ö° FORCE BUILD REQUESTED"
            echo "should_build=true" >> $GITHUB_OUTPUT
          elif [ "$LATEST_TAG" != "${{ vars.LAST_BUILT_TAG_AMD64 }}" ]; then
            echo "üÜï NEW VERSION DETECTED"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "‚úì Already up to date"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

          # OUTPUTS / SORTIES
          # $GITHUB_OUTPUT is a special file for passing data between steps
          # $GITHUB_OUTPUT est un fichier sp√©cial pour passer des donn√©es entre √©tapes
          #
          # ${LATEST_TAG#v} removes the 'v' prefix: v139 -> 139
          # ${LATEST_TAG#v} enl√®ve le pr√©fixe 'v': v139 -> 139
          echo "tag_name=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "version=${LATEST_TAG#v}" >> $GITHUB_OUTPUT

      # -----------------------------------------------------------------------
      # STEP 2: Checkout our repository
      # √âTAPE 2: R√©cup√©rer notre d√©p√¥t
      # -----------------------------------------------------------------------
      # Gets our snap/ configuration files (not the upstream source)
      # R√©cup√®re nos fichiers de configuration snap/ (pas le source upstream)
      #
      # CONDITIONAL EXECUTION / EX√âCUTION CONDITIONNELLE
      # 'if:' allows skipping steps based on conditions
      # 'if:' permet de passer des √©tapes selon des conditions
      #
      # steps.check.outputs.should_build references the output from step 'check'
      # steps.check.outputs.should_build r√©f√©rence l'output de l'√©tape 'check'
      # -----------------------------------------------------------------------
      - name: Checkout config
        if: steps.check.outputs.should_build == 'true'
        uses: actions/checkout@v4
        # ABOUT 'uses:' / √Ä PROPOS DE 'uses:'
        # References a reusable action from GitHub Marketplace or another repo
        # R√©f√©rence une action r√©utilisable du GitHub Marketplace ou d'un autre d√©p√¥t
        #
        # Format: owner/repo@version
        # actions/checkout@v4 = github.com/actions/checkout, version 4.x

      # -----------------------------------------------------------------------
      # STEP 3: Clone upstream source code
      # √âTAPE 3: Cloner le code source upstream
      # -----------------------------------------------------------------------
      # We clone the upstream project at the specific release tag, then
      # overlay our snap configuration on top of it.
      #
      # Nous clonons le projet upstream au tag de release sp√©cifique, puis
      # superposons notre configuration snap par-dessus.
      #
      # WHY OVERLAY? / POURQUOI SUPERPOSER ?
      # This approach keeps our snap config separate from upstream, making
      # it easy to update when new versions are released without merge conflicts.
      #
      # Cette approche garde notre config snap s√©par√©e de l'upstream, ce qui
      # facilite les MAJ lors de nouvelles versions sans conflits de merge.
      # -----------------------------------------------------------------------
      - name: Clone ares source
        if: steps.check.outputs.should_build == 'true'
        run: |
          echo "üì¶ Cloning ares ${{ steps.check.outputs.tag_name }}..."

          # --depth 1 : Shallow clone (only latest commit, saves time/bandwidth)
          #             Clone superficiel (seulement le dernier commit, √©conomise temps/bande passante)
          # --branch  : Checkout specific tag instead of default branch
          #             Checkout un tag sp√©cifique au lieu de la branche par d√©faut
          git clone --depth 1 --branch ${{ steps.check.outputs.tag_name }} \
            https://github.com/ares-emulator/ares.git ares-src

          # Overlay our snap configuration / Superposer notre config snap
          cp -r snap/ ares-src/

          # Copy dependency configuration / Copier la config des d√©pendances
          cp deps.json ares-src/

          # Inject version into snapcraft.yaml using sed
          # Injecter la version dans snapcraft.yaml avec sed
          #
          # sed -i : Edit file in-place / √âdite le fichier sur place
          # s/^version: .*/version: 'X'/ : Replace version line
          #                                 Remplace la ligne version
          sed -i "s/^version: .*/version: '${{ steps.check.outputs.version }}'/" ares-src/snap/snapcraft.yaml
          echo "‚úì Version set to ${{ steps.check.outputs.version }}"

      # -----------------------------------------------------------------------
      # STEP 4: Install Snapcraft
      # √âTAPE 4: Installer Snapcraft
      # -----------------------------------------------------------------------
      # Snapcraft is the tool that builds Snap packages
      # Snapcraft est l'outil qui construit les paquets Snap
      #
      # --classic : Allows snapcraft full system access (needed for building)
      #             Donne √† snapcraft un acc√®s complet au syst√®me (n√©cessaire pour builder)
      # -----------------------------------------------------------------------
      - name: Install snapcraft
        if: steps.check.outputs.should_build == 'true'
        run: sudo snap install snapcraft --classic

      # -----------------------------------------------------------------------
      # STEP 5: Install build dependencies
      # √âTAPE 5: Installer les d√©pendances de build
      # -----------------------------------------------------------------------
      # In --destructive-mode, snapcraft cannot install packages itself because
      # it doesn't run as root. We must pre-install all build-packages.
      #
      # En mode --destructive-mode, snapcraft ne peut pas installer les paquets
      # lui-m√™me car il ne tourne pas en root. On doit pr√©-installer les build-packages.
      # -----------------------------------------------------------------------
      - name: Install build dependencies
        if: steps.check.outputs.should_build == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            cmake \
            curl \
            jq \
            libao-dev \
            libasound2-dev \
            libgl-dev \
            libgtk-3-dev \
            libopenal-dev \
            libpulse-dev \
            libudev-dev \
            pkg-config

      # -----------------------------------------------------------------------
      # STEP 6: Build the Snap package
      # √âTAPE 6: Construire le paquet Snap
      # -----------------------------------------------------------------------
      # This is where the magic happens! Snapcraft reads snapcraft.yaml
      # and builds the .snap file.
      #
      # C'est ici que la magie op√®re ! Snapcraft lit snapcraft.yaml
      # et construit le fichier .snap.
      #
      # BUILD MODES / MODES DE BUILD:
      #   snapcraft pack                    : Build in a clean LXD container (recommended)
      #                                       Build dans un conteneur LXD propre (recommand√©)
      #   snapcraft pack --destructive-mode : Build directly on host (faster in CI)
      #                                       Build directement sur l'h√¥te (plus rapide en CI)
      #
      # WHY --destructive-mode? / POURQUOI --destructive-mode ?
      # In CI, the runner is ephemeral anyway, so we don't need container isolation.
      # This is faster because it skips LXD setup.
      # En CI, le runner est √©ph√©m√®re de toute fa√ßon, donc pas besoin d'isolation conteneur.
      # C'est plus rapide car √ßa √©vite la config LXD.
      # -----------------------------------------------------------------------
      - name: Build snap
        if: steps.check.outputs.should_build == 'true'
        id: build
        run: |
          cd ares-src
          snapcraft pack --destructive-mode

          # Find the generated .snap file and export its name
          # Trouver le fichier .snap g√©n√©r√© et exporter son nom
          echo "snap_file=$(ls *.snap)" >> $GITHUB_OUTPUT

      # -----------------------------------------------------------------------
      # STEP 7: Upload build artifact
      # √âTAPE 7: Uploader l'artifact de build
      # -----------------------------------------------------------------------
      # Artifacts are files preserved after the workflow completes.
      # Les artifacts sont des fichiers pr√©serv√©s apr√®s la fin du workflow.
      #
      # Useful for / Utile pour:
      #   - Downloading and testing builds manually
      #     T√©l√©charger et tester les builds manuellement
      #   - Sharing files between jobs
      #     Partager des fichiers entre jobs
      #   - Keeping build history
      #     Garder un historique des builds
      #
      # retention-days: How long to keep the artifact (max 90 for public repos)
      # retention-days: Combien de temps garder l'artifact (max 90 pour les d√©p√¥ts publics)
      # -----------------------------------------------------------------------
      - name: Upload artifact
        if: steps.check.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ares-${{ steps.check.outputs.tag_name }}-amd64
          path: ares-src/${{ steps.build.outputs.snap_file }}
          retention-days: 30

      # -----------------------------------------------------------------------
      # STEP 8: Publish to Snap Store
      # √âTAPE 8: Publier sur le Snap Store
      # -----------------------------------------------------------------------
      # Uploads the .snap file to the Snap Store for distribution
      # Upload le fichier .snap sur le Snap Store pour distribution
      #
      # AUTHENTICATION / AUTHENTIFICATION:
      # SNAPCRAFT_STORE_CREDENTIALS env var is automatically used by snapcraft
      # La variable d'env SNAPCRAFT_STORE_CREDENTIALS est utilis√©e automatiquement par snapcraft
      #
      # CHANNELS / CANAUX:
      #   stable    : Production-ready releases / Releases pr√™tes pour la production
      #   candidate : Release candidates for testing / Candidats de release pour tests
      #   beta      : Beta versions / Versions beta
      #   edge      : Latest development builds / Derniers builds de d√©veloppement
      #
      # continue-on-error: true
      # If publishing fails (e.g., name not registered yet), don't fail the whole job
      # Si la publication √©choue (ex: nom pas encore enregistr√©), ne pas √©chouer tout le job
      # -----------------------------------------------------------------------
      - name: Publish to Snap Store
        if: steps.check.outputs.should_build == 'true'
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        run: |
          echo "üöÄ Publishing to Snap Store (amd64)..."
          snapcraft upload ares-src/${{ steps.build.outputs.snap_file }} --release=stable
        continue-on-error: true

      # -----------------------------------------------------------------------
      # STEP 9: Update version tracking variable
      # √âTAPE 9: Mettre √† jour la variable de suivi de version
      # -----------------------------------------------------------------------
      # After successful build, update our tracking variable so we don't
      # rebuild the same version next time.
      #
      # Apr√®s un build r√©ussi, mettre √† jour notre variable de suivi pour ne pas
      # rebuilder la m√™me version la prochaine fois.
      #
      # gh variable set : GitHub CLI command to update a repository variable
      #                   Commande GitHub CLI pour MAJ une variable de d√©p√¥t
      #
      # --repo ${{ github.repository }} : Explicitly specify which repo
      #                                   Sp√©cifier explicitement quel d√©p√¥t
      # -----------------------------------------------------------------------
      - name: Update last built tag
        if: steps.check.outputs.should_build == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh variable set LAST_BUILT_TAG_AMD64 --body "${{ steps.check.outputs.tag_name }}"
          echo "‚úÖ Updated LAST_BUILT_TAG_AMD64 to ${{ steps.check.outputs.tag_name }}"

  # ===========================================================================
  # JOB: build-arm64
  # ===========================================================================
  # Builds the Snap package for ARM 64-bit processors (Raspberry Pi 4/5, etc.)
  # Construit le paquet Snap pour les processeurs ARM 64-bit (Raspberry Pi 4/5, etc.)
  #
  # This job is nearly identical to build-amd64, but runs on an ARM runner.
  # Ce job est quasi identique √† build-amd64, mais tourne sur un runner ARM.
  #
  # WHY SEPARATE JOBS? / POURQUOI DES JOBS S√âPAR√âS ?
  # - Each arch tracks its own "last built" version independently
  #   Chaque arch suit sa propre version "dernier build" ind√©pendamment
  # - One can build while the other skips if already up-to-date
  #   L'un peut builder pendant que l'autre passe si d√©j√† √† jour
  # - Native compilation is faster and more reliable than cross-compilation
  #   La compilation native est plus rapide et fiable que la cross-compilation
  # ===========================================================================
  build-arm64:
    # ubuntu-24.04-arm is GitHub's ARM64 runner
    # ubuntu-24.04-arm est le runner ARM64 de GitHub
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Check for new version
        id: check
        run: |
          LATEST_TAG=$(git ls-remote --tags https://github.com/ares-emulator/ares.git 'refs/tags/v*' \
            | cut -d/ -f3 \
            | sort -V \
            | tail -1)

          echo "=========================================="
          echo "Latest release tag: $LATEST_TAG"
          echo "Last built (arm64): ${{ vars.LAST_BUILT_TAG_ARM64 }}"
          echo "=========================================="

          if [ "${{ inputs.force_build }}" == "true" ]; then
            echo "‚ö° FORCE BUILD REQUESTED"
            echo "should_build=true" >> $GITHUB_OUTPUT
          elif [ "$LATEST_TAG" != "${{ vars.LAST_BUILT_TAG_ARM64 }}" ]; then
            echo "üÜï NEW VERSION DETECTED"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "‚úì Already up to date"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

          echo "tag_name=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "version=${LATEST_TAG#v}" >> $GITHUB_OUTPUT

      - name: Checkout config
        if: steps.check.outputs.should_build == 'true'
        uses: actions/checkout@v4

      - name: Clone ares source
        if: steps.check.outputs.should_build == 'true'
        run: |
          echo "üì¶ Cloning ares ${{ steps.check.outputs.tag_name }}..."
          git clone --depth 1 --branch ${{ steps.check.outputs.tag_name }} \
            https://github.com/ares-emulator/ares.git ares-src
          cp -r snap/ ares-src/
          cp deps.json ares-src/
          sed -i "s/^version: .*/version: '${{ steps.check.outputs.version }}'/" ares-src/snap/snapcraft.yaml
          echo "‚úì Version set to ${{ steps.check.outputs.version }}"

      - name: Install snapcraft
        if: steps.check.outputs.should_build == 'true'
        run: sudo snap install snapcraft --classic

      - name: Install build dependencies
        if: steps.check.outputs.should_build == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            cmake \
            curl \
            jq \
            libao-dev \
            libasound2-dev \
            libgl-dev \
            libgtk-3-dev \
            libopenal-dev \
            libpulse-dev \
            libudev-dev \
            pkg-config

      - name: Build snap
        if: steps.check.outputs.should_build == 'true'
        id: build
        run: |
          cd ares-src
          snapcraft pack --destructive-mode
          echo "snap_file=$(ls *.snap)" >> $GITHUB_OUTPUT

      - name: Upload artifact
        if: steps.check.outputs.should_build == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ares-${{ steps.check.outputs.tag_name }}-arm64
          path: ares-src/${{ steps.build.outputs.snap_file }}
          retention-days: 30

      - name: Publish to Snap Store
        if: steps.check.outputs.should_build == 'true'
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        run: |
          echo "üöÄ Publishing to Snap Store (arm64)..."
          snapcraft upload ares-src/${{ steps.build.outputs.snap_file }} --release=stable
        continue-on-error: true

      - name: Update last built tag
        if: steps.check.outputs.should_build == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh variable set LAST_BUILT_TAG_ARM64 --body "${{ steps.check.outputs.tag_name }}"
          echo "‚úÖ Updated LAST_BUILT_TAG_ARM64 to ${{ steps.check.outputs.tag_name }}"
