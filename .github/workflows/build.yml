# =============================================================================
# Ares Snap Builder - Automated Snap packaging for Ares emulator
# Constructeur Snap Ares - Packaging Snap automatisÃ© pour l'Ã©mulateur Ares
# =============================================================================
#
# This workflow automatically builds and publishes Snap packages whenever
# a new version of Ares is released. Builds natively for amd64 and arm64.
#
# Ce workflow construit et publie automatiquement des paquets Snap Ã  chaque
# nouvelle version d'Ares. Build natif pour amd64 et arm64.
#
# =============================================================================
# REQUIRED SETUP / CONFIGURATION REQUISE
# =============================================================================
#
# 1. TRACKING FILE / FICHIER DE SUIVI
#    Create .last_built_tags.json at repo root:
#    CrÃ©er .last_built_tags.json Ã  la racine du dÃ©pÃ´t :
#      {"amd64": "", "arm64": ""}
#
# 2. REPOSITORY SECRET (Settings > Secrets and variables > Actions > Secrets)
#    - SNAPCRAFT_TOKEN : from "snapcraft export-login"
#
# 3. REPOSITORY PERMISSIONS (Settings > Actions > General > Workflow permissions)
#    - Select "Read and write permissions"
# =============================================================================

name: Build Ares Snap

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build (bypass version check)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  # ===========================================================================
  # JOB 1: CHECK FOR NEW RELEASE
  # ===========================================================================
  check:
    runs-on: ubuntu-latest
    outputs:
      latest_tag: ${{ steps.check.outputs.latest_tag }}
      version: ${{ steps.check.outputs.version }}
      build_amd64: ${{ steps.check.outputs.build_amd64 }}
      build_arm64: ${{ steps.check.outputs.build_arm64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for new version
        id: check
        run: |
          LATEST_TAG=$(git ls-remote --tags https://github.com/ares-emulator/ares.git 'refs/tags/v*' \
            | cut -d/ -f3 \
            | sort -V \
            | tail -1)

          if [ -f .last_built_tags.json ]; then
            LAST_AMD64=$(jq -r '.amd64 // ""' .last_built_tags.json)
            LAST_ARM64=$(jq -r '.arm64 // ""' .last_built_tags.json)
          else
            LAST_AMD64=""
            LAST_ARM64=""
          fi

          echo "=========================================="
          echo "Latest release tag : $LATEST_TAG"
          echo "Last built amd64   : $LAST_AMD64"
          echo "Last built arm64   : $LAST_ARM64"
          echo "=========================================="

          if [ "${{ inputs.force_build }}" == "true" ]; then
            echo "âš¡ FORCE BUILD REQUESTED"
            BUILD_AMD64=true
            BUILD_ARM64=true
          else
            [ "$LATEST_TAG" != "$LAST_AMD64" ] && BUILD_AMD64=true || BUILD_AMD64=false
            [ "$LATEST_TAG" != "$LAST_ARM64" ] && BUILD_ARM64=true || BUILD_ARM64=false
          fi

          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "version=${LATEST_TAG#v}" >> $GITHUB_OUTPUT
          echo "build_amd64=$BUILD_AMD64" >> $GITHUB_OUTPUT
          echo "build_arm64=$BUILD_ARM64" >> $GITHUB_OUTPUT

  # ===========================================================================
  # JOB 2: BUILD AMD64
  # ===========================================================================
  build-amd64:
    needs: check
    if: needs.check.outputs.build_amd64 == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout config
        uses: actions/checkout@v4

      - name: Clone ares source
        run: |
          TAG=${{ needs.check.outputs.latest_tag }}
          VERSION=${{ needs.check.outputs.version }}
          echo "ğŸ“¦ Cloning ares $TAG (amd64)..."
          git clone --depth 1 --branch $TAG \
            https://github.com/ares-emulator/ares.git ares-src
          cp -r snap/ ares-src/
          cp deps.json ares-src/
          sed -i "s/^version: .*/version: '$VERSION'/" ares-src/snap/snapcraft.yaml
          echo "âœ“ Version set to $VERSION"

      - name: Install snapcraft
        run: sudo snap install snapcraft --classic

      - name: Setup LXD
        uses: canonical/setup-lxd@main

      - name: Build snap
        id: build
        run: |
          cd ares-src
          snapcraft pack
          echo "snap_file=$(ls *.snap)" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ares-${{ needs.check.outputs.latest_tag }}-amd64
          path: ares-src/${{ steps.build.outputs.snap_file }}
          retention-days: 30

      - name: Publish to Snap Store
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        run: |
          echo "ğŸš€ Publishing to Snap Store (amd64)..."
          snapcraft upload ares-src/${{ steps.build.outputs.snap_file }} --release=stable
        continue-on-error: true

  # ===========================================================================
  # JOB 3: BUILD ARM64
  # ===========================================================================
  build-arm64:
    needs: check
    if: needs.check.outputs.build_arm64 == 'true'
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout config
        uses: actions/checkout@v4

      - name: Clone ares source
        run: |
          TAG=${{ needs.check.outputs.latest_tag }}
          VERSION=${{ needs.check.outputs.version }}
          echo "ğŸ“¦ Cloning ares $TAG (arm64)..."
          git clone --depth 1 --branch $TAG \
            https://github.com/ares-emulator/ares.git ares-src
          cp -r snap/ ares-src/
          cp deps.json ares-src/
          sed -i "s/^version: .*/version: '$VERSION'/" ares-src/snap/snapcraft.yaml
          echo "âœ“ Version set to $VERSION"

      - name: Install snapcraft
        run: sudo snap install snapcraft --classic

      - name: Setup LXD
        uses: canonical/setup-lxd@main

      - name: Build snap
        id: build
        run: |
          cd ares-src
          snapcraft pack
          echo "snap_file=$(ls *.snap)" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ares-${{ needs.check.outputs.latest_tag }}-arm64
          path: ares-src/${{ steps.build.outputs.snap_file }}
          retention-days: 30

      - name: Publish to Snap Store
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        run: |
          echo "ğŸš€ Publishing to Snap Store (arm64)..."
          snapcraft upload ares-src/${{ steps.build.outputs.snap_file }} --release=stable
        continue-on-error: true

  # ===========================================================================
  # JOB 4: UPDATE TRACKING FILE
  # ===========================================================================
  # Runs after both builds. Updates .last_built_tags.json only for
  # architectures that built successfully, then commits + pushes.
  # A single final job avoids race conditions from parallel pushes.
  # ===========================================================================
  update-tags:
    needs: [check, build-amd64, build-arm64]
    if: always() && (needs.build-amd64.result == 'success' || needs.build-arm64.result == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update tracking file
        run: |
          TAG=${{ needs.check.outputs.latest_tag }}

          if [ -f .last_built_tags.json ]; then
            JSON=$(cat .last_built_tags.json)
          else
            JSON='{"amd64":"","arm64":""}'
          fi

          if [ "${{ needs.build-amd64.result }}" == "success" ]; then
            JSON=$(echo "$JSON" | jq --arg t "$TAG" '.amd64 = $t')
            echo "âœ… amd64 â†’ $TAG"
          fi
          if [ "${{ needs.build-arm64.result }}" == "success" ]; then
            JSON=$(echo "$JSON" | jq --arg t "$TAG" '.arm64 = $t')
            echo "âœ… arm64 â†’ $TAG"
          fi

          echo "$JSON" | jq . > .last_built_tags.json
          echo "ğŸ“„ Updated tracking file:"
          cat .last_built_tags.json

      - name: Commit
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .last_built_tags.json
          git diff --cached --quiet && echo "Nothing to commit" && exit 0
          git commit -m "ğŸ·ï¸ Track build ${{ needs.check.outputs.latest_tag }} [skip ci]"
          git push
